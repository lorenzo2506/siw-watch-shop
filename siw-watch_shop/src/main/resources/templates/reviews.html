<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title th:text="${'Recensioni - ' + watch.brand + ' ' + watch.name}">Recensioni Orologio</title>
    <link rel="stylesheet" th:href="@{/css/main.css}">
</head>
<body>
    <!-- Header -->
    <header th:replace="~{fragments/header :: header}"></header>

    <div class="reviews-container">
        <!-- Breadcrumb -->
        <nav class="breadcrumb">
            <a th:href="@{/}">Home</a>
            <span>›</span>
            <a th:href="@{/watches}">Orologi</a>
            <span>›</span>
            <a th:href="@{/watch/{id}(id=${watch.id})}" th:text="${watch.brand + ' ' + watch.name}">Orologio</a>
            <span>›</span>
            <span>Recensioni</span>
        </nav>

        <!-- Header Orologio -->
        <div class="reviews-header">
            <div class="watch-summary">
                <div class="watch-summary-image">
                    <img th:if="${watch.imagePath}" th:src="@{/images/{filename}(filename=${watch.imagePath})}" th:alt="${watch.name}" class="watch-summary-img">
                    <div th:unless="${watch.imagePath}" class="watch-summary-placeholder">⌚</div>
                </div>
                <div class="watch-summary-info">
                    <h1 class="watch-summary-title">
                        <span class="watch-summary-brand" th:text="${watch.brand}">Brand</span>
                        <span class="watch-summary-name" th:text="${watch.name}">Nome Orologio</span>
                    </h1>
                    <div class="watch-summary-rating">
                        <div th:if="${watch.averageRating != null}" class="rating-display">
                            <div class="stars">
                                <span th:each="i : ${#numbers.sequence(1, 5)}" 
                                      th:class="${i <= watch.averageRating} ? 'star filled' : 'star'">★</span>
                            </div>
                            <span class="rating-value" th:text="${#numbers.formatDecimal(watch.averageRating, 1, 1)}">4.5</span>
                            <span class="rating-count" th:text="'(' + ${watch.ratingCount} + ' recensioni)'">
                                (12 recensioni)
                            </span>
                        </div>
                        
                    </div>
                </div>
            </div>
        </div>

        <!-- Recensione dell'utente corrente (se presente) -->
        <div th:if="${userReview != null}" class="user-review-section">
            <h2>La Tua Recensione</h2>
            <div class="review-card user-review">
                <div class="review-header">
                    <div class="review-author">
                        <div class="author-avatar">
                            <span th:text="${#strings.substring(userReview.user.name, 0, 1) + #strings.substring(userReview.user.surname, 0, 1)}">JD</span>
                        </div>
                        <div class="author-info">
                            <h4 th:text="${userReview.user.name + ' ' + userReview.user.surname}">Nome Cognome</h4>
                            <span class="review-date" th:text="${#temporals.format(userReview.createdAt, 'dd MMMM yyyy')}">Data</span>
                        </div>
                    </div>
                    <div class="review-actions">
                        <a th:href="@{/watch/{watchId}/reviews/{reviewId}/editForm(watchId=${watch.id}, reviewId=${userReview.id})}" 
                           class="btn-edit-review" title="Modifica recensione">
                            ✎
                        </a>
                        <form th:action="@{/watch/{watchId}/reviews/{reviewId}/delete(watchId=${watch.id}, reviewId=${userReview.id})}" 
                              method="post" style="display: inline;">
                            <button type="submit" class="btn-delete-review" title="Elimina recensione" 
                                    onclick="return confirm('Sei sicuro di voler eliminare la tua recensione?')">
                                🗑
                            </button>
                        </form>
                    </div>
                </div>
                <div class="review-rating">
                    <div class="stars">
                        <span th:each="i : ${#numbers.sequence(1, 5)}" 
                              th:class="${i <= userReview.star_rating} ? 'star filled' : 'star'">★</span>
                    </div>
                    <span class="rating-value" th:text="${userReview.star_rating}">5</span>
                </div>
                <div class="review-text" th:text="${userReview.text}">
                    Testo della recensione dell'utente...
                </div>
            </div>
        </div>

        <!-- Form per nuova recensione (solo se utente autenticato e non ha già recensito) -->
        <div th:if="${isUser and userReview == null}" class="review-form-section">
            <h2>Scrivi una Recensione</h2>
            <form th:action="@{/watch/{watchId}/reviews(watchId=${watch.id})}" 
                  th:object="${review}" method="post" class="review-form">
                
                <!-- Rating -->
                <div class="form-group">
                    <label for="star_rating">Valutazione *</label>
                    <div class="rating-input">
                        <input type="radio" id="star5" name="star_rating" value="5" th:field="*{star_rating}">
                        <label for="star5" class="star-label">★</label>
                        <input type="radio" id="star4" name="star_rating" value="4" th:field="*{star_rating}">
                        <label for="star4" class="star-label">★</label>
                        <input type="radio" id="star3" name="star_rating" value="3" th:field="*{star_rating}">
                        <label for="star3" class="star-label">★</label>
                        <input type="radio" id="star2" name="star_rating" value="2" th:field="*{star_rating}">
                        <label for="star2" class="star-label">★</label>
                        <input type="radio" id="star1" name="star_rating" value="1" th:field="*{star_rating}">
                        <label for="star1" class="star-label">★</label>
                    </div>
                    <span th:if="${#fields.hasErrors('star_rating')}" 
                          th:errors="*{star_rating}" class="error-message"></span>
                </div>

                <!-- Testo recensione -->
                <div class="form-group">
                    <label for="text">Recensione *</label>
                    <textarea id="text" th:field="*{text}" 
                              placeholder="Condividi la tua esperienza con questo orologio..."
                              rows="5" required></textarea>
                    <span th:if="${#fields.hasErrors('text')}" 
                          th:errors="*{text}" class="error-message"></span>
                    <div class="form-hint">Massimo 1000 caratteri</div>
                </div>

                <!-- Pulsanti -->
                <div class="form-actions">
                    <button type="submit" class="btn-submit-review">
                        Pubblica Recensione
                    </button>
                    <a th:href="@{/watch/{id}(id=${watch.id})}" class="btn-cancel">
                        Annulla
                    </a>
                </div>
            </form>
        </div>

        <!-- Prompt login per utenti non autenticati -->
        <div th:unless="${isAuthenticated}" class="login-prompt">
            <h2>Vuoi scrivere una recensione?</h2>
            <p>Accedi al tuo account per condividere la tua esperienza con questo orologio.</p>
            <div class="auth-actions">
                <a th:href="@{/login}" class="btn-login">Accedi</a>
                <a th:href="@{/register}" class="btn-register">Registrati</a>
            </div>
        </div>

        <!-- Lista delle altre recensioni -->
        <div class="reviews-list-section">
            <h2 th:if="${#lists.size(reviews) > 0}">
                Altre Recensioni 
                <span class="reviews-count" th:text="'(' + ${#lists.size(reviews)} + ')'"></span>
            </h2>
            
            <div th:if="${#lists.isEmpty(reviews) and userReview == null}" class="no-reviews">
                <div class="no-reviews-icon">💭</div>
                <h3>Nessuna recensione ancora pubblicata</h3>
                <p th:if="${userReview == null and !isAdmin}">Sii il primo a recensire questo orologio!</p>
                <p th:if="${userReview != null and !isAdmin}">Sei l'unico ad aver recensito questo orologio.</p>
            </div>

            <div class="reviews-list" th:if="${#lists.size(reviews) > 0}">
                <div th:each="reviewItem : ${reviews}" class="review-card">
                    <div class="review-header">
                        <div class="review-author">
                            <div class="author-avatar">
                                <span th:text="${#strings.substring(reviewItem.user.name, 0, 1) + #strings.substring(reviewItem.user.surname, 0, 1)}">JD</span>
                            </div>
                            <div class="author-info">
                                <h4 th:text="${reviewItem.user.name + ' ' + reviewItem.user.surname}">Nome Cognome</h4>
                                <span class="review-date" th:text="${#temporals.format(reviewItem.createdAt, 'dd MMMM yyyy')}">Data</span>
                            </div>
                        </div>
                        <!-- Azioni admin: solo admin può eliminare tutte le recensioni -->
                        <div th:if="${isAdmin}" class="review-actions">
                            <form th:action="@{/admin/watch/{watchId}/reviews/{reviewId}/delete(watchId=${watch.id}, reviewId=${reviewItem.id})}" 
                                  method="post" style="display: inline;">
                                <button type="submit" class="btn-admin-delete" title="Elimina recensione (Admin)" 
                                        onclick="return confirm('Sei sicuro di voler eliminare questa recensione?')">
                                    🗑
                                </button>
                            </form>
                        </div>
                    </div>
                    <div class="review-rating">
                        <div class="stars">
                            <span th:each="i : ${#numbers.sequence(1, 5)}" 
                                  th:class="${i <= reviewItem.star_rating} ? 'star filled' : 'star'">★</span>
                        </div>
                        <span class="rating-value" th:text="${reviewItem.star_rating}">5</span>
                    </div>
                    <div class="review-text" th:text="${reviewItem.text}">
                        Testo della recensione...
                    </div>
                </div>
            </div>
        </div>

        <!-- Link ritorno orologio -->
        <div class="back-to-watch">
            <a th:href="@{/watch/{id}(id=${watch.id})}" class="btn-back">
                ← Torna all'Orologio
            </a>
        </div>
    </div>

    <!-- Footer -->
    <footer th:replace="~{fragments/footer :: footer}"></footer>
</body>
</html>