<!DOCTYPE html>
<html lang="it" xmlns:th="http://www.thymeleaf.org" 
      th:replace="~{fragments/layout :: base(~{::title}, ~{::main})}">
<head>
    <title th:text="${pageTitle} ?: 'Scegli Username - TimeCraft'">Scegli Username - TimeCraft</title>
</head>
<body>
    <main>
        <div class="auth-container">
            <div class="auth-card">
                <div class="auth-header">
                    <h1>âŒš TimeCraft</h1>
                    <h2 th:text="${pageTitle} ?: 'Scegli il tuo username'">Scegli il tuo username</h2>
                    
                    <!-- Messaggio di benvenuto per OAuth -->
                    <div th:if="${isOAuth2}" class="welcome-message">
                        <p th:text="${welcomeMessage}">Benvenuto!</p>
                    </div>
                    
                    <p th:text="${instructions}">Ultimo passaggio per completare la registrazione</p>
                </div>

                <!-- Progress indicator per registrazione normale -->
                <div class="progress-steps" th:unless="${isOAuth2}">
                    <div class="step completed">
                        <span class="step-number">âœ“</span>
                        <span class="step-label">Dati Personali</span>
                    </div>
                    <div class="step-line completed"></div>
                    <div class="step active">
                        <span class="step-number">2</span>
                        <span class="step-label">Username</span>
                    </div>
                </div>

                <!-- Progress indicator per OAuth -->
                <div class="oauth-progress" th:if="${isOAuth2}">
                    <div class="oauth-step">
                        <span class="oauth-icon">ðŸŽ¯</span>
                        <span class="oauth-label">Ultimo passaggio</span>
                    </div>
                </div>

                <!-- Messaggi di errore -->
                <div th:if="${usernameExists}" class="alert alert-error" th:text="${usernameExists}"></div>
                <div th:if="${errorMessage}" class="alert alert-error" th:text="${errorMessage}"></div>

                <div class="auth-form-container">
                    <!-- Username Selection Form -->
                    <form class="auth-form" th:action="@{/register/step2}" method="post" th:object="${credentials}">
                        <!-- Hidden fields per mantenere i dati dalla sessione -->
                        <input type="hidden" th:field="*{email}">
                        <input type="hidden" th:field="*{password}">
                        <input type="hidden" th:if="*{user?.name}" th:field="*{user.name}">
                        <input type="hidden" th:if="*{user?.surname}" th:field="*{user.surname}">

                        <div class="form-group">
                            <label for="username">Username *</label>
                            <input type="text" id="username" name="username" th:field="*{username}" 
                                   placeholder="Il tuo username unico" required>
                            <small class="form-hint">SarÃ  visibile agli altri utenti nella community</small>
                        </div>

                        <!-- Recap info per conferma -->
                        <div class="user-recap" th:if="*{email}">
                            <h4>ðŸ“‹ Riepilogo account:</h4>
                            <div class="recap-info">
                                <span class="recap-label">Email:</span>
                                <span class="recap-value" th:text="*{email}"></span>
                            </div>
                            <div class="recap-info" th:if="*{user?.name}">
                                <span class="recap-label">Nome:</span>
                                <span class="recap-value" th:text="*{user.name} + ' ' + *{user.surname}"></span>
                            </div>
                            <div class="recap-info">
                                <span class="recap-label">Tipo account:</span>
                                <span class="recap-value" th:text="${isOAuth2} ? 'Google OAuth' : 'Registrazione diretta'"></span>
                            </div>
                        </div>

                        <div class="form-actions">
                            <a th:href="@{/register/cancel}" class="btn-auth-secondary">Annulla</a>
                            <button type="submit" class="btn-auth-primary">
                                <span th:if="${isOAuth2}">Completa Registrazione</span>
                                <span th:unless="${isOAuth2}">Crea Account</span>
                            </button>
                        </div>
                    </form>

                    <!-- Note privacy -->
                    <div class="auth-footer">
                        <p class="privacy-note">
                            Continuando, accetti i nostri 
                            <a href="#" class="link-secondary">Termini di Servizio</a> e la 
                            <a href="#" class="link-secondary">Privacy Policy</a>
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </main>
</body>
</html>